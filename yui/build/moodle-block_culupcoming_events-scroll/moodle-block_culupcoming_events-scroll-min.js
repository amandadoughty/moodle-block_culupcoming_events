YUI.add("moodle-block_culupcoming_events-scroll",function(e,t){M.block_culupcoming_events=M.block_culupcoming_events||{},M.block_culupcoming_events.scroll={lookahead:365,courseid:0,limitnum:null,page:0,scroller:null,reloader:null,timer:null,init:function(t){e.one(".pages")&&e.one(".pages").hide();try{var n=e.one(".block_culupcoming_events .reload"),r=e.one(".block_culupcoming_events"),i=r.get("id");i=i.replace("inst","");var s=e.one("#instance-"+i+"-header");s.append(n),n.setStyle("display","inline-block"),e.one(".reload .block_culupcoming_events_reload").on("click",this.reloadblock,this)}catch(o){}this.scroller=e.one(".block_culupcoming_events .culupcoming_events"),this.scroller.on("scroll",this.filltobelowblock,this),this.lookahead=t.lookahead,this.courseid=t.courseid,this.limitnum=t.limitnum,this.page=t.page,this.timer=e.later(3e5,this,this.reloadevents,[],!0),this.filltobelowblock();var u=M.core.dock.get();u.on(["dock:initialised","dock:itemadded"],function(){e.Array.each(u.dockeditems,function(t){t.on("dockeditem:showcomplete",function(){if(t.get("blockclass")==="culupcoming_events")try{var n=e.one(".dockeditempanel_hd .block_culupcoming_events_reload");if(!n){var r=e.one(".block_culupcoming_events .reload").cloneNode(!0),i=e.one("#instance-"+t.get("blockinstanceid")+"-header");i.append(r),r.setStyle("display","inline-block"),n=e.one(".dockeditempanel_hd .block_culupcoming_events_reload")}n&&n.on("click",this.reloadblock,this)}catch(s){}},this)},this)},this)},filltobelowblock:function(){var t=this.scroller.get("scrollHeight"),n=this.scroller.get("scrollTop"),r=this.scroller.get("clientHeight"),i,s;if(t-(n+r)<10){this.timer.cancel();var o=e.all(".block_culupcoming_events .culupcoming_events li").size();if(o>0){var u=e.all(".block_culupcoming_events .culupcoming_events li").item(o-1);i=u.get("id").split("_")[0],s=u.get("id").split("_")[1]}else i=0,s=0;this.addevents(o,i,s),this.timer=e.later(3e5,this,this.reloadevents,[],!0)}},reloadblock:function(e){e.preventDefault(),this.reloadevents(e)},addevents:function(t,n,r){this.scroller.detach("scroll"),e.one(".block_culupcoming_events_reload").setStyle("display","none"),e.one(".block_culupcoming_events_loading").setStyle("display","inline-block");var i={sesskey:M.cfg.sesskey,lookahead:this.lookahead,courseid:this.courseid,lastid:n,lastdate:r,limitfrom:1,limitnum:this.limitnum,page:this.page};e.io(M.cfg.wwwroot+"/blocks/culupcoming_events/scroll_ajax.php",{method:"POST",data:window.build_querystring(i),context:this,on:{success:function(t,n){var r=e.JSON.parse(n.responseText);r.error?this.timer.cancel():e.one(".block_culupcoming_events .culupcoming_events ul").append(r.output),r.end||this.scroller.on("scroll",this.filltobelowblock,this),e.one(".block_culupcoming_events_loading").setStyle("display","none"),e.one(".block_culupcoming_events_reload").setStyle("display","inline-block")},failure:function(){e.one(".block_culupcoming_events_loading").setStyle("display","none"),e.one(".block_culupcoming_events_reload").setStyle("display","inline-block"),this.timer.cancel()}}})},reloadevents:function(){var t=0,n=e.all(".block_culupcoming_events .culupcoming_events li").size();n&&(t=this.scroller.all("li").item(n-1).get("id").split("_")[0]),e.one(".block_culupcoming_events_reload").setStyle("display","none"),e.one(".block_culupcoming_events_loading").setStyle("display","inline-block");var r={sesskey:M.cfg.sesskey,lookahead:this.lookahead,courseid:this.courseid,limitnum:this.limitnum,page:this.page};e.io(M.cfg.wwwroot+"/blocks/culupcoming_events/reload_ajax.php",{method:"POST",data:window.build_querystring(r),context:this,on:{success:function(t,n){var r=e.JSON.parse(n.responseText);r.error?this.timer.cancel():r.output&&e.one(".block_culupcoming_events .culupcoming_events ul").set("innerHTML",r.output),e.one(".block_culupcoming_events_loading").setStyle("display","none"),e.one(".block_culupcoming_events_reload").setStyle("display","inline-block")},failure:function(){e.one(".block_culupcoming_events_loading").setStyle("display","none"),e.one(".block_culupcoming_events_reload").setStyle("display","inline-block"),this.timer.cancel()}}})}}},"@VERSION@",{requires:["base","node","io","json-parse","dom-core","querystring","event-custom","moodle-core-dock"]});
